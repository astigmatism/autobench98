# services/orchestrator/Dockerfile.dev
FROM node:20-alpine

ENV NPM_CONFIG_FUND=false \
    NPM_CONFIG_AUDIT=false

WORKDIR /app

# Bring in the whole monorepo so npm can resolve workspaces
COPY . .

# ✅ Required for serialport enumeration on Alpine (provides `udevadm`)
RUN apk add --no-cache eudev

# Upgrade npm and install all workspaces at repo root
RUN npm install -g npm@11 \
    && npm --version \
    && npm install --workspaces

# Build the shared logging lib (TS → dist)
RUN npm -w packages/logging run build

# Build the frontend once so /app/ can be served by Fastify in dev
RUN npm -w apps/web run build

# Run orchestrator in dev (tsx watch)
WORKDIR /app/services/orchestrator
CMD ["npm", "run", "dev"]