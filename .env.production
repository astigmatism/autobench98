################################################################################
# AutoBench98 Environment Production
# Copy to .env and adjust per environment (dev, stage, prod)
################################################################################

# ------------------------------------------------------------------------------
# Global settings
# ------------------------------------------------------------------------------
NODE_ENV=production             # Node environment: development | production | test

# ------------------------------------------------------------------------------
# Orchestrator service
# ------------------------------------------------------------------------------
API_PORT=3000                    # HTTP port for orchestrator
API_HOST=0.0.0.0                 # Bind address
LOG_LEVEL=info                   # Default orchestrator log level
PRETTY_LOGS=true                 # Pretty-print logs to console (true = human readable)
DATA_DIR=./data/orchestrator     # Host data directory (used by orchestrator for layouts, etc.)

# ------------------------------------------------------------------------------
# Sidecar service
# ------------------------------------------------------------------------------
SIDECAR_PORT=3100                # HTTP port for sidecar
SIDECAR_HOST=0.0.0.0             # Bind address for sidecar

# ------------------------------------------------------------------------------
# Request logging controls
# ------------------------------------------------------------------------------
REQUEST_VERBOSE=false            # true -> include debug blocks with id/ip and optional headers
REQUEST_LOG_HEADERS=false        # true -> include a safe subset of headers (no auth/cookies)
REQUEST_SAMPLE=1                 # N -> log every Nth request (sampling factor)

# ------------------------------------------------------------------------------
# WebSocket log streaming controls (server â†’ client)
# ------------------------------------------------------------------------------
LOG_CHANNEL_ALLOWLIST=websocket,app,sidecar,device,powermeter,serial-printer   # Channels exposed to WS clients
LOG_LEVEL_MIN=debug               # Minimum level forwarded (debug|info|warn|error|fatal)
LOG_REDACT_REGEX=                 # Regex (JS) to redact sensitive data (e.g., Bearer tokens)
CLIENT_LOGS_SNAPSHOT=500          # How many recent log entries to send to new clients
CLIENT_LOGS_CAPACITY=5000         # Suggested client-side ring buffer size (server-driven cap)

# ------------------------------------------------------------------------------
# External log ingestion (for sidecar or other processes)
# ------------------------------------------------------------------------------
LOG_INGEST_TOKEN=devtoken        # Optional bearer token for POST /api/logs/ingest (empty = disabled)
LOG_INGEST_ALLOWED_CHANNELS=sidecar,ffmpeg,device,ocr,stream,benchmark  # Channels accepted for ingestion

# ------------------------------------------------------------------------------
# Sidecar â†’ Orchestrator log forwarding
# ------------------------------------------------------------------------------
ORCH_INGEST_URL=http://localhost:3000/api/logs/ingest  # Orchestrator ingestion endpoint (host-run)
ORCH_INGEST_TOKEN=devtoken        # Token used by sidecar to authenticate (must match LOG_INGEST_TOKEN)

# ------------------------------------------------------------------------------
# WebSocket server â€” heartbeat logging (optional)
# ------------------------------------------------------------------------------
WS_HEARTBEAT_LOG=false            # If true, log ðŸ’“ heartbeat pongs to the WS log channel

# ------------------------------------------------------------------------------
# WebSocket client (Studio) â€” values SOURCE THE SERVER CONFIG (server-owned)
# The orchestrator reads these and exposes them via state.serverConfig.ws.
# ------------------------------------------------------------------------------
VITE_WS_HEARTBEAT_INTERVAL_MS=10000   # Client ping cadence (ms)
VITE_WS_HEARTBEAT_TIMEOUT_MS=5000     # Time to wait for server pong before reconnect (ms)
VITE_WS_RECONNECT_ENABLED=true        # Auto-reconnect when disconnected
VITE_WS_RECONNECT_MIN_MS=1000         # Minimum reconnect backoff delay (ms)
VITE_WS_RECONNECT_MAX_MS=15000        # Maximum reconnect backoff delay (ms)
VITE_WS_RECONNECT_FACTOR=1.8          # Exponential backoff factor
VITE_WS_RECONNECT_JITTER=0.2          # Jitter fraction (0..1) applied to backoff

# Serial printer UI â€“ typewriter streaming controls (Studio)
VITE_SERIAL_PRINTER_TYPING_INTERVAL_MS=20   # Delay between reveal ticks (ms)
VITE_SERIAL_PRINTER_CHARS_PER_TICK=1        # Characters revealed per tick

# ------------------------------------------------------------------------------
# Serial discovery (USB/Arduino controllers) â€” Orchestrator-owned
# ------------------------------------------------------------------------------
SERIAL_DEFAULT_BAUD=9600         # Default baudRate when not specified by a matcher
SERIAL_IDENTIFY_REQUEST=identify # Line written to request identity
SERIAL_IDENTIFY_COMPLETION=identify_complete  # Line written after success (empty to disable)
SERIAL_PARSER_DELIM=\r\n         # Parser line delimiter (Arduino println => \r\n)
SERIAL_WRITE_EOL=\n              # EOL used when writing lines to the device
SERIAL_TIMEOUT_MS=750           # Per-attempt identify timeout (ms)
SERIAL_RETRIES=1                 # Per-port identify retries
SERIAL_STARTUP_SETTLE_MS=500

SERIAL_RESCAN_MS=0               # >0 => periodic rescan interval (ms); 0/empty => single pass on boot
SERIAL_SUMMARY_MS=0          # Periodic device summary logs (ms); falls back to RESCAN if unset
SERIAL_LOG_PREFIX=serial         # Prefix added to relayed discovery logs

# Optional: drive matchers from env instead of code (JSON array)
# macOS example filters to real Arduino ports (avoid Bluetooth/console TTYs):
#   - /dev/tty.usbmodem* or /dev/tty.usbserial*
SERIAL_MATCHERS_JSON=

# ------------------------------------------------------------------------------
# Serial startup readiness (required devices) â€” all must be present at boot
# ------------------------------------------------------------------------------
# JSON array of required devices. Each item must be positively identified.
# Fields:
#   id        : REQUIRED Arduino "identify" token (e.g., KB, MS, FP, AC, PR, PM)
#   kind      : Optional device kind to narrow match (e.g., arduino.ps2.keyboard)
#   vendorId  : Optional USB VID (hex, e.g., 2341)
#   productId : Optional USB PID (hex, e.g., 8037)
#   pathRegex : Optional regex string to match a specific TTY path
#   baudRate  : Optional override if needed
# Example:
# SERIAL_REQUIRED_DEVICES_JSON=[
#   {"id":"KB","kind":"arduino.ps2.keyboard","baudRate":9600},
#   {"id":"MS","kind":"arduino.ps2.mouse","baudRate":9600},
#   {"id":"FP","kind":"arduino.frontpanel","baudRate":9600},
#   {"id":"AC","kind":"arduino.atxcontroller"},
#   {"id":"PR","kind":"serial.printer","pathRegex":".*USB.*"},
#   {"id":"PM","kind":"serial.powermeter","vendorId":"1a86","productId":"7523"}
# ]
SERIAL_REQUIRED_DEVICES_JSON='[
    {
        "kind": "serial.powermeter",
        "vendorId": "0403",
        "productId": "6001",
        "serialNumber": "A7005IDU",
        "baudRate": 115200
    }
]'

SERIAL_STARTUP_TIMEOUT_MS=30000  # How long to wait for all required devices at startup (ms)
SERIAL_FAIL_ON_MISSING=true      # true => abort startup if required devices not found by timeout

# ------------------------------------------------------------------------------
# Serial printer (Win98 capture) â€” static device plugged via USBâ€“serial adapter
# ------------------------------------------------------------------------------
# These settings control how the SerialPrinterService reads raw print streams
# from the Windows 98 box. In most cases the port path will be discovered
# via SERIAL_REQUIRED_DEVICES_JSON (kind=serial.printer), so SERIAL_PRINTER_PORT
# is only needed as an override.
#
# DEV (macOS) example:
#   SERIAL_PRINTER_PORT=/dev/tty.usbserial-A9XDX1MS
#
# DEV/PROD (Linux) example:
#   SERIAL_PRINTER_PORT=/dev/ttyUSB0
#
# If left empty, the service uses the discovered port from serial discovery.
SERIAL_PRINTER_PORT=             # Optional explicit override for serial-printer device

# Baud settings â€” usually 9600 for this adapter; change only if Win98 side differs.
SERIAL_PRINTER_BAUD=9600         # DEV/PROD: keep in sync with Win98 COM port settings

# How long (ms) with no data before we treat the job as "complete".
# - DEV: you may use a smaller value (e.g., 300â€“500) to see jobs complete quickly.
# - PROD: a slightly larger value (e.g., 500â€“1000) is safer if output is bursty.
SERIAL_PRINTER_IDLE_FLUSH_MS=500

# Maximum number of jobs to keep in memory (FIFO). When exceeded, the oldest jobs
# are dropped to make room for new ones.
# - DEV: 16â€“32 is usually enough.
# - PROD: bump to 64+ if you expect long sessions or delayed consumption.
SERIAL_PRINTER_MAX_QUEUED_JOBS=32

# Reconnect policy when the serial-printer device disappears.
# - DEV: you may allow unlimited attempts for debugging.
# - PROD: prefer a bounded number of attempts and surface fatal errors to the UI.
SERIAL_PRINTER_RECONNECT_ENABLED=true          # false => do not auto-reconnect
SERIAL_PRINTER_RECONNECT_MAX_ATTEMPTS=5        # 0 => unlimited attempts
SERIAL_PRINTER_RECONNECT_BASE_DELAY_MS=1000    # First delay before retry (ms)
SERIAL_PRINTER_RECONNECT_MAX_DELAY_MS=10000    # Max backoff delay (ms)

# Line ending used when decoding the stream for preview / text display.
# Options: CRLF | LF
# - Win9x text/RAW printing is usually CRLF.
SERIAL_PRINTER_LINE_ENDING=CRLF

# How many characters of a job to keep as a "preview" snippet.
# This is purely for UI/logging; the full job body is always stored.
# - DEV: 120â€“160 shows a nice slice in logs.
# - PROD: same; increase if you want more detail in log views.
SERIAL_PRINTER_PREVIEW_CHARS=160

# ------------------------------------------------------------------------------
# Serial power meter (WattsUp? PRO) â€” static device plugged via USBâ€“serial adapter
# ------------------------------------------------------------------------------
# These settings control how the SerialPowerMeterService interacts with the
# WattsUp power meter. The actual device path and baud rate are normally
# discovered via SERIAL_REQUIRED_DEVICES_JSON (kind=serial.powermeter).
#
# DEV (macOS) example path (from discovery matcher):
#   usbserial-A7005IDU  -> /dev/cu.usbserial-A7005IDU
#
# DEV/PROD (Linux) example:
#   /dev/ttyUSB1
#
# Sampling interval in seconds. This maps to the WattsUp command:
#   #L,W,3,E,,<INTERVAL>;
# A value of 1 produces 1 Hz samples (recommended).
SERIAL_PM_SAMPLING_INTERVAL_SEC=1

# Maximum number of recent samples to keep in memory for observability/UI.
# This does NOT affect recorder buffers; only the rolling "live view" buffer.
SERIAL_PM_MAX_RECENT_SAMPLES=120

# Full handling mode for:
#   #O,W,1,<FULLHANDLING>;
# The default of 3 matches wattsup.py and the exploratory MJS probe.
SERIAL_PM_FULL_HANDLING=3

# Reconnect policy when the power meter device disappears or the port errors.
# - DEV: allow unlimited attempts (0) for debugging.
# - PROD: prefer bounded attempts and surface fatal errors to the UI.
SERIAL_PM_RECONNECT_ENABLED=true               # false => do not auto-reconnect
SERIAL_PM_RECONNECT_MAX_ATTEMPTS=5             # 0 => unlimited attempts
SERIAL_PM_RECONNECT_BASE_DELAY_MS=1000         # First delay before retry (ms)
SERIAL_PM_RECONNECT_MAX_DELAY_MS=10000         # Max backoff delay (ms)
