################################################################################
# AutoBench98 Environment Production
# Copy to .env and adjust per environment (dev, stage, prod)
################################################################################

# ------------------------------------------------------------------------------
# Global settings
# ------------------------------------------------------------------------------
NODE_ENV=production             # Node environment: development | production | test

# ------------------------------------------------------------------------------
# Orchestrator service
# ------------------------------------------------------------------------------
API_PORT=3000                    # HTTP port for orchestrator
API_HOST=0.0.0.0                 # Bind address
LOG_LEVEL=info                   # Default orchestrator log level
PRETTY_LOGS=true                 # Pretty-print logs to console (true = human readable)
DATA_DIR=./data/orchestrator     # Host data directory (used by orchestrator for layouts, etc.)

# ------------------------------------------------------------------------------
# Sidecar service
# ------------------------------------------------------------------------------
SIDECAR_PORT=3100                # HTTP port for sidecar
SIDECAR_HOST=0.0.0.0             # Bind address for sidecar

# ------------------------------------------------------------------------------
# Request logging controls
# ------------------------------------------------------------------------------
REQUEST_VERBOSE=false            # true -> include debug blocks with id/ip and optional headers
REQUEST_LOG_HEADERS=false        # true -> include a safe subset of headers (no auth/cookies)
REQUEST_SAMPLE=1                 # N -> log every Nth request (sampling factor)

# ------------------------------------------------------------------------------
# WebSocket log streaming controls (server â†’ client)
# ------------------------------------------------------------------------------
LOG_CHANNEL_ALLOWLIST=websocket,app,sidecar,device,powermeter,serial-printer,atlona-controller,cf-imager   # Channels exposed to WS clients
LOG_LEVEL_MIN=debug               # Minimum level forwarded (debug|info|warn|error|fatal)
LOG_REDACT_REGEX=                 # Regex (JS) to redact sensitive data (e.g., Bearer tokens)
CLIENT_LOGS_SNAPSHOT=500          # How many recent log entries to send to new clients
CLIENT_LOGS_CAPACITY=5000         # Suggested client-side ring buffer size (server-driven cap)

# ------------------------------------------------------------------------------
# External log ingestion (for sidecar or other processes)
# ------------------------------------------------------------------------------
LOG_INGEST_TOKEN=devtoken        # Optional bearer token for POST /api/logs/ingest (empty = disabled)
LOG_INGEST_ALLOWED_CHANNELS=sidecar,ffmpeg,device,ocr,stream,benchmark  # Channels accepted for ingestion

# ------------------------------------------------------------------------------
# Sidecar â†’ Orchestrator log forwarding
# ------------------------------------------------------------------------------
ORCH_INGEST_URL=http://localhost:3000/api/logs/ingest  # Orchestrator ingestion endpoint (host-run)
ORCH_INGEST_TOKEN=devtoken        # Token used by sidecar to authenticate (must match LOG_INGEST_TOKEN)

# ------------------------------------------------------------------------------
# WebSocket server â€” heartbeat logging (optional)
# ------------------------------------------------------------------------------
WS_HEARTBEAT_LOG=false            # If true, log ðŸ’“ heartbeat pongs to the WS log channel

# ------------------------------------------------------------------------------
# WebSocket client (Studio) â€” values SOURCE THE SERVER CONFIG (server-owned)
# The orchestrator reads these and exposes them via state.serverConfig.ws.
# ------------------------------------------------------------------------------
VITE_WS_HEARTBEAT_INTERVAL_MS=10000   # Client ping cadence (ms)
VITE_WS_HEARTBEAT_TIMEOUT_MS=5000     # Time to wait for server pong before reconnect (ms)
VITE_WS_RECONNECT_ENABLED=true        # Auto-reconnect when disconnected
VITE_WS_RECONNECT_MIN_MS=1000         # Minimum reconnect backoff delay (ms)
VITE_WS_RECONNECT_MAX_MS=15000        # Maximum reconnect backoff delay (ms)
VITE_WS_RECONNECT_FACTOR=1.8          # Exponential backoff factor
VITE_WS_RECONNECT_JITTER=0.2          # Jitter fraction (0..1) applied to backoff

# Serial printer UI â€“ typewriter streaming controls (Studio)
VITE_SERIAL_PRINTER_TYPING_INTERVAL_MS=12   # Lower = faster & smoother typing (more updates/sec). Higher = slower & choppier.
VITE_SERIAL_PRINTER_CHARS_PER_TICK=1        # Higher = more chars per update (faster but chunkier). Lower = smoother but slower.

# ------------------------------------------------------------------------------
# Serial discovery (USB/Arduino controllers) â€” Orchestrator-owned
# ------------------------------------------------------------------------------
SERIAL_DEFAULT_BAUD=9600         # Default baudRate when not specified by a matcher
SERIAL_IDENTIFY_REQUEST=identify # Line written to request identity
SERIAL_IDENTIFY_COMPLETION=identify_complete  # Line written after success (empty to disable)
SERIAL_PARSER_DELIM=\r\n         # Parser line delimiter (Arduino println => \r\n)
SERIAL_WRITE_EOL=\n              # EOL used when writing lines to the device
SERIAL_TIMEOUT_MS=750           # Per-attempt identify timeout (ms)
SERIAL_RETRIES=1                 # Per-port identify retries
SERIAL_STARTUP_SETTLE_MS=500

SERIAL_RESCAN_MS=0               # >0 => periodic rescan interval (ms); 0/empty => single pass on boot
SERIAL_SUMMARY_MS=0          # Periodic device summary logs (ms); falls back to RESCAN if unset
SERIAL_LOG_PREFIX=serial         # Prefix added to relayed discovery logs

# Optional: drive matchers from env instead of code (JSON array)
# macOS example filters to real Arduino ports (avoid Bluetooth/console TTYs):
#   - /dev/tty.usbmodem* or /dev/tty.usbserial*
SERIAL_MATCHERS_JSON=

# ------------------------------------------------------------------------------
# Serial startup readiness (required devices) â€” all must be present at boot
# ------------------------------------------------------------------------------
# JSON array of required devices. Each item must be positively identified.
# Fields:
#   id        : REQUIRED Arduino "identify" token (e.g., KB, MS, FP, AC, PR, PM)
#   kind      : Optional device kind to narrow match (e.g., arduino.ps2.keyboard)
#   vendorId  : Optional USB VID (hex, e.g., 2341)
#   productId : Optional USB PID (hex, e.g., 8037)
#   pathRegex : Optional regex string to match a specific TTY path
#   baudRate  : Optional override if needed
# Example:
# SERIAL_REQUIRED_DEVICES_JSON=[
#   {"id":"KB","kind":"arduino.ps2.keyboard","baudRate":9600},
#   {"id":"MS","kind":"arduino.ps2.mouse","baudRate":9600},
#   {"id":"FP","kind":"arduino.frontpanel","baudRate":9600},
#   {"id":"AC","kind":"arduino.atxcontroller"},
#   {"id":"PR","kind":"serial.printer","pathRegex":".*USB.*"},
#   {"id":"PM","kind":"serial.powermeter","vendorId":"1a86","productId":"7523"}
# ]
SERIAL_REQUIRED_DEVICES_JSON='[
    {"id":"AC","kind":"arduino.atlonacontroller","baudRate":9600},
        {
        "kind": "serial.printer",
        "vendorId": "0403",
        "productId": "6001",
        "serialNumber": "BG00YT15",
        "baudRate": 115200
    },
    {
        "kind": "serial.powermeter",
        "vendorId": "0403",
        "productId": "6001",
        "serialNumber": "A7005IDU",
        "baudRate": 115200
    }
]'

SERIAL_STARTUP_TIMEOUT_MS=30000  # How long to wait for all required devices at startup (ms)
SERIAL_FAIL_ON_MISSING=true      # true => abort startup if required devices not found by timeout

# ------------------------------------------------------------------------------
# Serial printer (Win98 capture) â€” static device plugged via USBâ€“serial adapter
# ------------------------------------------------------------------------------
# These settings control how the SerialPrinterService reads raw print streams
# from the Windows 98 box. In most cases the port path will be discovered
# via SERIAL_REQUIRED_DEVICES_JSON (kind=serial.printer), so SERIAL_PRINTER_PORT
# is only needed as an override.
#
# DEV (macOS) example:
#   SERIAL_PRINTER_PORT=/dev/tty.usbserial-A9XDX1MS
#
# DEV/PROD (Linux) example:
#   SERIAL_PRINTER_PORT=/dev/ttyUSB0
#
# If left empty, the service uses the discovered port from serial discovery.
SERIAL_PRINTER_PORT=             # Optional explicit override for serial-printer device

# Baud settings â€” usually 9600 for this adapter; change only if Win98 side differs.
SERIAL_PRINTER_BAUD=115200         # DEV/PROD: keep in sync with Win98 COM port settings

# How long (ms) with no data before we treat the job as "complete".
# - DEV: you may use a smaller value (e.g., 300â€“500) to see jobs complete quickly.
# - PROD: a slightly larger value (e.g., 500â€“1000) is safer if output is bursty.
SERIAL_PRINTER_IDLE_FLUSH_MS=300

# Flow control for the serial printer capture.
# Must match the Win98 COM port setting:
#   NONE      â†’ no flow control
#   SOFTWARE  â†’ XON/XOFF
#   HARDWARE  â†’ RTS/CTS
# Win9x printer ports are commonly configured with XON/XOFF, so SOFTWARE is
# a good default when capturing from Windows 98.
SERIAL_PRINTER_FLOW_CONTROL=SOFTWARE

# Maximum number of jobs to keep in memory (FIFO). When exceeded, the oldest jobs
# are dropped to make room for new ones.
# - DEV: 16â€“32 is usually enough.
# - PROD: bump to 64+ if you expect long sessions or delayed consumption.
SERIAL_PRINTER_MAX_QUEUED_JOBS=32

# Reconnect policy when the serial-printer device disappears.
# - DEV: you may allow unlimited attempts for debugging.
# - PROD: prefer a bounded number of attempts and surface fatal errors to the UI.
SERIAL_PRINTER_RECONNECT_ENABLED=true          # false => do not auto-reconnect
SERIAL_PRINTER_RECONNECT_MAX_ATTEMPTS=5        # 0 => unlimited attempts
SERIAL_PRINTER_RECONNECT_BASE_DELAY_MS=1000    # First delay before retry (ms)
SERIAL_PRINTER_RECONNECT_MAX_DELAY_MS=10000    # Max backoff delay (ms)

# Line ending used when decoding the stream for preview / text display.
# Options: CRLF | LF
# - Win9x text/RAW printing is usually CRLF.
SERIAL_PRINTER_LINE_ENDING=CRLF

# How many completed print jobs to keep in server-side history for the Studio
# tape view. Oldest jobs are dropped when this limit is exceeded.
# - DEV: 5â€“10 keeps things light.
# - PROD: 10â€“50 depending on memory and session length.
SERIAL_PRINTER_HISTORY_LIMIT=50

# ------------------------------------------------------------------------------
# Serial power meter (WattsUp? PRO) â€” wattsup CLI + child-process reader
# ------------------------------------------------------------------------------
# These settings control how the SerialPowerMeterService interacts with the
# WattsUp power meter via the external `wattsup` command-line tool.
#
# The actual USBâ€“serial device is still discovered via SERIAL_REQUIRED_DEVICES_JSON
# (kind=serial.powermeter). Discovery supplies the device path (e.g. /dev/ttyUSB0),
# and this service spawns the `wattsup` binary and reads its CSV stdout.
#
# Example manual invocation for reference:
#   ./native/wattsup/wattsup /dev/ttyUSB0 -r -s
#
# where:
#   -r  => "realtime" / continuous streaming mode
#   -s  => 1-second interval (see SERIAL_PM_SAMPLING_INTERVAL_SEC below)

# ------------------------------------------------------------------------------
# Core sampling + buffering
# ------------------------------------------------------------------------------

# Sampling interval in seconds. This is the logical expected cadence of samples
# (used for recording quality and gap warnings). For the stock `wattsup` binary
# invoked with `-s`, a value of 1 corresponds to ~1 Hz updates.
#
# NOTE: This no longer sends any serial protocol commands itself; it just tells
#       the service what cadence to expect from the child process.
SERIAL_PM_SAMPLING_INTERVAL_SEC=1

# Maximum number of recent samples to keep in memory for observability/UI.
# This does NOT affect recorder buffers; only the rolling "live view" buffer
# used by getRecentSamples() and any dashboards.
SERIAL_PM_MAX_RECENT_SAMPLES=120

# ------------------------------------------------------------------------------
# Reconnect / restart policy for the wattsup child process
# ------------------------------------------------------------------------------

# Controls whether the service will automatically attempt to restart the
# `wattsup` child process when it exits unexpectedly or hits a fatal error.
#
# This is about process-level failures (spawn/exit), not missing samples.
SERIAL_PM_RECONNECT_ENABLED=true               # false => do not auto-restart

# Maximum number of restart attempts before giving up and moving the meter
# into a terminal error state. Set to 0 for unlimited attempts (DEV only).
SERIAL_PM_RECONNECT_MAX_ATTEMPTS=5             # 0 => unlimited attempts

# Exponential backoff configuration for restart attempts (in milliseconds).
SERIAL_PM_RECONNECT_BASE_DELAY_MS=1000         # First delay before retry
SERIAL_PM_RECONNECT_MAX_DELAY_MS=10000         # Max backoff delay

# ------------------------------------------------------------------------------
# Soft restart based on missing samples (watchdog)
# ------------------------------------------------------------------------------

# SERIAL_PM_ENABLE_SOFT_DISCONNECT:
#   - In the new design this controls "soft restart" of the wattsup child
#     process when the gap-monitor watchdog observes a long period with no
#     samples, even though the process is still running.
#
# Behavior:
#   - If false (default):
#       - The gap monitor will still log warnings when no sample is seen for
#         >= 3 seconds, but it will NOT restart the child process.
#   - If true:
#       - When no sample is seen for >= 6 seconds, the service triggers a
#         soft restart by treating it as a child error and letting the normal
#         restart policy (above) handle it.
#
# Rationale:
#   - Short gaps (2â€“3s) are considered tolerable and only logged.
#   - Longer gaps (>=6s) may indicate a stuck driver/CLI, and a restart can
#     be helpful in DEV/PROD where self-healing is desired.
SERIAL_PM_ENABLE_SOFT_DISCONNECT=false

# ------------------------------------------------------------------------------
# WattsUp binary location
# ------------------------------------------------------------------------------

# Path to the `wattsup` CLI binary used by this service.
#
# IMPORTANT:
#   This path is resolved from INSIDE `services/orchestrator/`
#   because that is the working directory of the Node process.
#
# Therefore, if your repo looks like:
#   AUTOBENCH98/
#     vendor/
#       wattsup/
#         linux-amd64/
#           wattsup
#     services/
#       orchestrator/
#
# â€¦then the correct relative path is:
#   ../../vendor/wattsup/linux-amd64/wattsup
#
# Example (relative to orchestrator):
#   SERIAL_PM_WATTSUP_PATH=../vendor/wattsup/linux-amd64/wattsup
#
# Example (absolute path):
#   SERIAL_PM_WATTSUP_PATH=/home/astigmatism/autobench98/vendor/wattsup/linux-amd64/wattsup
#
SERIAL_PM_WATTSUP_PATH=../../vendor/wattsup/linux-amd64/wattsup

# ------------------------------------------------------------------------------
# Debug / logging
# ------------------------------------------------------------------------------

# SERIAL_PM_DEBUG_FRAMES:
#   - When true, the service logs each CSV row received from the wattsup
#     child process, e.g.:
#         [powermeter:debug] 2025-12-05T21:36:01.239Z csv row "1.4,118.6,..."
#
#   - The gap-monitor watchdog also respects this flag:
#       - When true:
#           - Logs a single warning when no sample has been seen for >= 3s:
#               [powermeter:warn] ... no wattsup sample received for ...
#           - Optionally logs and triggers a soft restart when the gap
#             reaches >= 6s and SERIAL_PM_ENABLE_SOFT_DISCONNECT=true.
#
#       - When false:
#           - The watchdog runs but stays quiet; no warn logs are emitted.
#
#   - Recommended:
#       - DEV: true while tuning meter behavior.
#       - PROD: false to keep logs quieter unless diagnosing issues.
SERIAL_PM_DEBUG_FRAMES=false


# ------------------------------------------------------------------------------
# Atlona Controller (HD500 scaler front-panel emulator) â€” Arduino Pro Micro
# ------------------------------------------------------------------------------
# These settings control how the AtlonaControllerService interacts with the
# Arduino-based front-panel emulator. The actual device path and baud rate are
# normally discovered via SERIAL_REQUIRED_DEVICES_JSON (kind=arduino.atlonacontroller).
#
# Reconnect policy when the Atlona controller device disappears or the port errors.
# - DEV: allow unlimited attempts (0) for debugging.
# - PROD: prefer bounded attempts and surface fatal errors to the UI.
ATLONA_RECONNECT_ENABLED=true                # false => do not auto-reconnect
ATLONA_RECONNECT_MAX_ATTEMPTS=0              # 0 => unlimited attempts
ATLONA_RECONNECT_BASE_DELAY_MS=1000          # First delay before retry (ms)
ATLONA_RECONNECT_MAX_DELAY_MS=10000          # Max backoff delay (ms)

# Identification / handshake timing.
# From the sketch: we send "identify", expect "AC", then send "identify_complete".
# If the device is slow to enumerate or wake, bump this for PROD.
ATLONA_IDENTIFY_TIMEOUT_MS=3000              # Max time to wait for "AC" response (ms)

# Optional default press duration for "tap" presses (pressSwitch).
# Frontend or benchmark flows can override, but this is a sensible default.
ATLONA_PRESS_HOLD_MS=200                     # How long to hold a button for a "press" (ms)

# ------------------------------------------------------------------------------
# CompactFlash Imager â€” CF reader / writer via bash scripts
# ------------------------------------------------------------------------------
# Root directory for CF image files. All file browser actions operate inside
# this directory. It can be outside the repo; ~ is expanded to $HOME.
CF_IMAGER_ROOT=~/autobench98-images

# Paths to the bash scripts that perform read/write operations.
# These are resolved from the orchestrator working directory.
CF_IMAGER_READ_SCRIPT=../../vendor/cf-imager/linux/read-image-linux.sh
CF_IMAGER_WRITE_SCRIPT=../../vendor/cf-imager/linux/write-linux-macos.sh

# Optional: max entries per directory returned to the UI.
CF_IMAGER_MAX_ENTRIES=500

# Optional: restrict which file types are shown in the CF image browser
# (directories are always shown). Comma-separated, case-insensitive extensions
# without dots, e.g.: "img,iso". If unset or empty, all file types are shown.
CF_IMAGER_VISIBLE_EXTENSIONS=img

# CompactFlash reader USB identity (used by CfBlockDiscoveryService)
# Hex values can be with or without 0x, case-insensitive.
CF_IMAGER_USB_VENDOR_ID=0bda
CF_IMAGER_USB_PRODUCT_ID=0321
CF_IMAGER_USB_SERIAL=201412031053
# Optional: how often to poll for presence/media (ms).
CF_IMAGER_USB_POLL_MS=3000
# Optional: how often the orchestrator should rescan the CF_IMAGER_ROOT directory
# to detect external changes (new/removed/renamed files). Value is in milliseconds.
# Set to 0 or leave unset to disable polling entirely.
# Reasonable range: 1000â€“5000 (1sâ€“5s). Default (when unset): 3000.
CF_IMAGER_FS_POLL_MS=3000